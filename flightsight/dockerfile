# empty
FROM debian:bookworm-slim
FROM debian:bookworm-slim AS builder

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies for rtl-sdr and readsb
RUN apt-get update \
	&& apt-get install -y --no-install-recommends \
	   git build-essential debhelper pkg-config fakeroot help2man \
	   libncurses-dev zlib1g-dev libzstd-dev libusb-1.0-0-dev \
	   librtlsdr-dev libsoapysdr-dev libhackrf-dev libbladerf-dev libad9361-dev libiio-dev \
	   dpkg-dev devscripts dh-autoreconf autoconf automake libtool cmake ca-certificates \
	&& rm -rf /var/lib/apt/lists/* \
	&& mkdir -p /out

# Build rtl-sdr .deb packages
RUN git clone https://github.com/osmocom/rtl-sdr /tmp/rtl-sdr \
	&& cd /tmp/rtl-sdr \
	&& dpkg-buildpackage -b --no-sign || true \
	&& mv /tmp/*.deb /out/ || true \
	&& rm -rf /tmp/rtl-sdr

# Build readsb .deb package (pin depth for speed)
RUN git clone --depth 20 https://github.com/wiedehopf/readsb.git /tmp/readsb \
	&& cd /tmp/readsb \
	&& export DEB_BUILD_OPTIONS=noddebs \
	&& dpkg-buildpackage -b -ui -uc -us --build-profiles=rtlsdr || true \
	&& mv /tmp/readsb_*.deb /out/ || true \
	&& rm -rf /tmp/readsb

# Build tar1090 (static web UI) into /out for the runtime stage
RUN git clone --depth 20 https://github.com/wiedehopf/tar1090.git /tmp/tar1090 \
	&& mv /tmp/tar1090 /out/tar1090 \
	&& rm -rf /tmp/tar1090 || true

### Runtime image: keep small and only install runtime deps + supervisor
FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

# Minimal runtime deps (plus supervisor); additional deps will be installed by apt -f if needed
# Use Python's simple HTTP server instead of lighttpd
RUN apt-get update \
	&& apt-get install -y --no-install-recommends ca-certificates libusb-1.0-0 supervisor dpkg python3 \
	&& rm -rf /var/lib/apt/lists/*

# Copy produced .debs from builder and install them
COPY --from=builder /out/*.deb /tmp/
RUN dpkg -i /tmp/*.deb || true \
	&& apt-get update \
	&& apt-get -y -f install \
	&& rm -rf /var/lib/apt/lists/* /tmp/*.deb

# Install tar1090 static files into expected share location
# tar1090 expects files under /usr/local/share/tar1090/html
COPY --from=builder /out/tar1090 /usr/local/share/tar1090/html
RUN mkdir -p /usr/local/share/tar1090/html \
	&& chown -R www-data:www-data /usr/local/share/tar1090 || true


## Environment-configurable readsb location and options (defaults can be overridden at runtime)
ENV READSB_LAT=40.0190 \
	READSB_LON=105.2747 \
	READSB_OPTS=

# Supervisor configuration: run `readsb` as a supervised service. Use a shell command so
# environment variables are expanded at container runtime.
RUN mkdir -p /etc/supervisor/conf.d /var/log/readsb \
	&& printf '[program:readsb]\ncommand=/bin/sh -c "readsb --net --lat ${READSB_LAT} --lon ${READSB_LON} ${READSB_OPTS}"\nautostart=true\nautorestart=true\nstdout_logfile=/var/log/readsb/readsb.log\nstderr_logfile=/var/log/readsb/readsb.err\nuser=root\n' > /etc/supervisor/conf.d/readsb.conf

# Supervisor program for tar1090 (serve static files via lighttpd on port 8080)
RUN mkdir -p /var/log/tar1090 /usr/local/share/tar1090/html/html || true
RUN printf '[program:tar1090]\ncommand=/usr/bin/python3 -u -m http.server 8080 --directory /usr/local/share/tar1090/html/html\nautostart=true\nautorestart=true\nstdout_logfile=/var/log/tar1090/tar1090.log\nstderr_logfile=/var/log/tar1090/tar1090.err\nuser=root\n' > /etc/supervisor/conf.d/tar1090.conf

# Simple healthcheck: ensure `readsb` process is running
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 CMD pgrep readsb >/dev/null || exit 1

# Start supervisord in foreground so Docker runs supervised processes
CMD ["/usr/bin/supervisord","-n","-c","/etc/supervisor/supervisord.conf"]
